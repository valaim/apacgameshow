<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auction Game - Participant</title>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Shared CSS -->
  <link rel="stylesheet" href="gameshow.css">
</head>
<body>

<header>
  <button class="back-btn" onclick="window.location.href='index.html'" title="Back">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 18l-6-6 6-6"/>
      <path d="M9 12h12"/>
    </svg>
  </button>
  🎯 Auction Game
</header>

<div class="container">
  <div><strong>Round:</strong> <span id="roundNum">1</span></div>

  <!-- Select Team -->
  <div class="team-select-row">
    <label for="teamSelect">Select Your Team:</label>
    <select id="teamSelect">
      <option value="Team 1">Team 1</option>
      <option value="Team 2">Team 2</option>
      <option value="Team 3">Team 3</option>
      <option value="Team 4">Team 4</option>
      <option value="Team 5">Team 5</option>
    </select>
  </div>

  <h2>Your Bid</h2>
  <div class="form-row">
    <input type="number" id="bidInput" placeholder="Enter your bid">
    <button onclick="submitBid()">💸 Submit Bid</button>
  </div>

  <div class="status">💰 Money: <span id="remainingMoney">1000</span></div>
  <div class="status">⭐ Score: <span id="totalScore">0</span></div>
  <div class="status" id="statusMessage">⏳ Waiting for round to finish...</div>
</div>

<div class="container">
  <h3>📊 Current Auction Leaderboard</h3>
  <table id="auctionScoreboard">
    <thead>
      <tr>
        <th>Team</th>
        <th>Bid ($)</th>
        <th>Money ($)</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCqHMhVHAeOn3A8MMcvjVT_6h14jbZhzW0",
  authDomain: "apacgameshow-f8d5d.firebaseapp.com",
  databaseURL: "https://apacgameshow-f8d5d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "apacgameshow-f8d5d",
  storageBucket: "apacgameshow-f8d5d.firebasestorage.app",
  messagingSenderId: "572761881903",
  appId: "1:572761881903:web:3caef7b2e394a9d430f5da"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let selectedTeam = document.getElementById('teamSelect').value;
let lastMoney = null;
let lastScore = null;

// --- Change team selection ---
document.getElementById('teamSelect').addEventListener('change', function () {
  selectedTeam = this.value;
  lastMoney = null;
  lastScore = null;
  listenToMyTeam();
});

// --- Submit Bid ---
function submitBid() {
  const bid = parseFloat(document.getElementById('bidInput').value) || 0;
  if (bid <= 0) {
    alert("Please enter a valid bid amount.");
    return;
  }
  // Get my team's current money before setting bid
  db.ref('teams/' + selectedTeam + '/money').once('value').then(snap => {
    let money = snap.val() ?? 1000;
    if (bid > money) {
      alert("You don't have enough money for this bid!");
      return;
    }
    // Set my team's bid
    db.ref('auction/bids/' + selectedTeam).set(bid);
    document.getElementById('statusMessage').innerText = `✅ Bid of $${bid} placed successfully!`;
  });
}

// --- Listen for My Team Money/Score ---
function listenToMyTeam() {
  // Money & Score
  db.ref('teams/' + selectedTeam).on('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      const moneyEl = document.getElementById('remainingMoney');
      const scoreEl = document.getElementById('totalScore');

      if (lastMoney !== null && data.money !== lastMoney) {
        if (data.money > lastMoney) {
          moneyEl.classList.add('score-update');
        } else {
          moneyEl.classList.add('score-decrease');
        }
        setTimeout(() => moneyEl.classList.remove('score-update', 'score-decrease'), 1000);
      }

      if (lastScore !== null && data.score !== lastScore) {
        if (data.score > lastScore) {
          scoreEl.classList.add('score-update');
        } else {
          scoreEl.classList.add('score-decrease');
        }
        setTimeout(() => scoreEl.classList.remove('score-update', 'score-decrease'), 1000);
      }

      moneyEl.innerText = data.money ?? 1000;
      scoreEl.innerText = data.score ?? 0;

      lastMoney = data.money;
      lastScore = data.score;
    }
  });

  // Round Win/Loss Message
  db.ref('auction/currentRoundWinner').on('value', snapshot => {
    const winner = snapshot.val();
    if (winner) {
      document.getElementById('statusMessage').innerText =
        (winner.includes(selectedTeam)) ? "🎉 You won this round!" : "😢 You lost this round.";
    } else {
      document.getElementById('statusMessage').innerText = "⏳ Waiting for round to finish...";
    }
  });
}

// --- Auto-update Current Round ---
db.ref('auction/currentRound').on('value', snap => {
  document.getElementById('roundNum').innerText = snap.val() ?? 1;
});

// --- Live Leaderboard ---
function loadLeaderboard() {
  function renderLeaderboard(teams, bids) {
    const tableData = Object.keys(teams).map(team => ({
      team,
      bid: bids[team] || 0,
      money: teams[team].money || 0,
      score: teams[team].score || 0
    }));

    // Sort by score first, then money
    tableData.sort((a, b) => b.score - a.score || b.money - a.money);

    const tbody = document.querySelector("#auctionScoreboard tbody");
    tbody.innerHTML = "";
    tableData.forEach(row => {
      tbody.innerHTML += `<tr>
        <td>${row.team}</td>
        <td>${row.bid}</td>
        <td>${row.money}</td>
        <td>${row.score}</td>
      </tr>`;
    });
  }

  let latestBids = {};
  let latestTeams = {};

  // Listen for bid changes
  db.ref('auction/bids').on('value', snapBids => {
    latestBids = snapBids.val() || {};
    renderLeaderboard(latestTeams, latestBids);
  });

  // Listen for team changes
  db.ref('teams').on('value', snapTeams => {
    latestTeams = snapTeams.val() || {};
    renderLeaderboard(latestTeams, latestBids);
  });
}

// --- Init ---
listenToMyTeam();
loadLeaderboard();
</script>

</body>
</html>
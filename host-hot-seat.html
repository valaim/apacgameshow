<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hot Seat - Host View</title>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="gameshow.css">
<style>
    .wrong-btn { background: grey; }
    .reset-btn { background: darkred; }
    .reset-btn:hover { background: red; }
    .wrong-team { color: red; font-weight: bold; }
</style>
</head>
<body>

<header>
  <button class="back-btn" onclick="window.location.href='host-menu.html'" title="Back">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 18l-6-6 6-6"/>
      <path d="M9 12h12"/>
    </svg>
  </button>
  🔥 Hot Seat - Host
</header>

<div class="container">
    <h3>Round: <span id="roundNum">1</span> / 5</h3>
    <div class="form-row">
      <button onclick="startRound()">▶ Start Round</button>
      <button onclick="endRound()">⏹ End Round</button>
    </div>
    <table>
        <thead><tr><th>Buzz Order</th><th>Countdown / Action</th></tr></thead>
        <tbody id="buzzTable"></tbody>
    </table>
    <div class="form-row">
      <button onclick="nextRound()">⏭ Next Round</button>
      <button class="reset-btn" onclick="resetGame()">🔄 Reset Game</button>
    </div>
</div>

<!-- 📋 Answer Reference Panel -->
<div class="container" id="answerRefContainer">
  <h3>📋 Answer Reference</h3>
  <div id="answerDisplay" class="answer-hidden">Click to Reveal</div>
</div>

<div class="container">
    <h3>📊 Total Scores</h3>
    <table>
        <thead><tr><th>Team</th><th>Score</th></tr></thead>
        <tbody id="scoreTable"></tbody>
    </table>
</div>

<!-- Winner Control -->
<div class="container">
  <div class="winner-control">
    <label for="winnerSelect">Declare Mini‑Game Winner:</label>
    <select id="winnerSelect">
      <option value="">-- Select Team --</option>
      <option value="Team 1">Team 1</option>
      <option value="Team 2">Team 2</option>
      <option value="Team 3">Team 3</option>
      <option value="Team 4">Team 4</option>
      <option value="Team 5">Team 5</option>
    </select>
    <button onclick="declareWinner()">✅ Set Winner</button>
  </div>
</div>

<script>
// ==================== 📋 QUESTIONS & ANSWERS ====================
const answers = {
  1: {
    type: "grouped-shared",
    answers: {
      "Group 1": ["Manish Nagpal","Kang Min Kim","Jackael Lv","Koeun Chung","Bimal Balakrishnan"],
      "Group 2": ["Manish Nagpal","Jackael Lv","Percival Lawrence Ramos","Koeun Chung","Kang Min Kim"],
      "Group 3": ["Kang Min Kim","Jackael Lv","Percival Lawrence Ramos","Koeun Chung","Bimal Balakrishnan"],
      "Group 4": ["Manish Nagpal","Kang Min Kim","Koeun Chung","Bimal Balakrishnan","Percival Lawrence Ramos"],
      "Group 5": ["Manish Nagpal","Jackael Lv","Percival Lawrence Ramos","Kang Min Kim","Bimal Balakrishnan"]
    }
  },
  2: { type: "grouped-shared", /* your original Q2 answers */ },
  3: {
    type: "shared",
    answers: [
      "AdeS (soy-based beverages)",
      "Aquarius",
      "Ayataka green tea",
      "Costa Coffee",
      "Dasani waters",
      "Del Valle juices and nectars",
      "Fairlife",
      "Fanta",
      "Fuze Tea",
      "Georgia coffee",
      "Gold Peak teas and coffees",
      "ILOHAS",
      "Minute Maid juices",
      "Powerade sports drinks",
      "Simply juices and Simply Spiked",
      "Schweppes",
      "smartwater",
      "Sprite",
      "Topo Chico waters and hard seltzers",
      "vitaminwater"
    ]
  },
  4: { type: "grouped-shared", /* your original Q4 answers */ }
};

// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
  apiKey: "AIzaSyCqHMhVHAeOn3A8MMcvjVT_6h14jbZhzW0",
  authDomain: "apacgameshow-f8d5d.firebaseapp.com",
  databaseURL: "https://apacgameshow-f8d5d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "apacgameshow-f8d5d",
  storageBucket: "apacgameshow-f8d5d.firebasestorage.app",
  messagingSenderId: "572761881903",
  appId: "1:572761881903:web:3caef7b2e394a9d430f5da"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==================== Render Buzz Table with Countdown ====================
function renderBuzzTable(data) {
    const order = data.buzzOrder || [];
    const wrongTeams = data.wrongTeams || [];
    const buzzTimes = data.buzzTimes || {};

    const tbody = document.getElementById("buzzTable");
    tbody.innerHTML = "";
    order.forEach(team => {
        const className = wrongTeams.includes(team) ? "wrong-team" : "";
        let countdownDisplay = "--";
        if (buzzTimes[team]) {
            const elapsed = Math.floor((Date.now() - buzzTimes[team]) / 1000);
            const remaining = 5 - elapsed;
            countdownDisplay = remaining > 0 ? `${remaining}s` : "0s";
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="${className}">${team}</td>
            <td>
                ⏳ ${countdownDisplay}
                <button onclick="awardPoints('${team}')">✅ Correct</button>
                <button class="wrong-btn" onclick="markWrong('${team}')">❌ Wrong</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Listen to hotSeat changes
db.ref("hotSeat").on("value", snap => {
    renderBuzzTable(snap.val() || {});
});

// Auto-refresh countdown every second
setInterval(() => {
    db.ref("hotSeat").once("value").then(snap => {
        renderBuzzTable(snap.val() || {});
    });
}, 1000);

// ==================== ROUND TRACKING ====================
db.ref("hotSeat/currentRound").on("value", snap => {
    document.getElementById("roundNum").innerText = snap.val() || 1;
    resetAnswerPanel();
});

// ==================== CLICK TO REVEAL ANSWERS ====================
let answersVisible = false;
document.getElementById("answerDisplay").addEventListener("click", () => {
    const round = parseInt(document.getElementById("roundNum").innerText, 10);
    const answerData = answers[round];
    const display = document.getElementById("answerDisplay");
    if (!answersVisible) {
        if (!answerData) {
            display.innerText = "❌ No answer data for this round";
        } else {
            let html = "";
            if (answerData.type === "grouped-shared") {
                html += '<div class="answer-grid">';
                Object.entries(answerData.answers).forEach(([group, list]) => {
                    html += `<div class="answer-card">
                              <h4>${group}</h4>
                              <ul>${list.map(item => `<li>${item}</li>`).join("")}</ul>
                             </div>`;
                });
                html += '</div>';
            } else if (answerData.type === "shared") {
                html += '<div class="answer-shared-grid">';
                answerData.answers.forEach(item => {
                    html += `<div class="answer-shared-card">${item}</div>`;
                });
                html += '</div>';
            }
            display.innerHTML = html;
        }
        display.classList.add("answer-visible");
        display.classList.remove("answer-hidden");
        answersVisible = true;
    } else {
        resetAnswerPanel();
    }
});

function resetAnswerPanel() {
    document.getElementById("answerDisplay").innerText = "Click to Reveal";
    document.getElementById("answerDisplay").classList.remove("answer-visible");
    document.getElementById("answerDisplay").classList.add("answer-hidden");
    answersVisible = false;
}

// ==================== ROUND CONTROLS ====================
function startRound() {
    db.ref("hotSeat").update({
        buzzOrder: [],
        buzzTimes: {},
        wrongTeams: [],
        currentBuzz: null,
        roundActive: true,
        roundStartTime: Date.now()
    });
}

function endRound() {
    db.ref("hotSeat").update({
        roundActive: false,
        currentBuzz: null,
        buzzOrder: [],
        buzzTimes: {},
        wrongTeams: []
    });
}

function nextRound() {
    db.ref("hotSeat/currentRound").transaction(r => (r || 1) + 1);
    db.ref("hotSeat").update({
        buzzOrder: [],
        buzzTimes: {},
        wrongTeams: [],
        currentBuzz: null,
        roundActive: false,
        roundStartTime: null
    });
}

// ==================== CORRECT / WRONG ====================
function awardPoints(team) {
    db.ref(`teams/${team}/score`).transaction(score => (score || 0) + 3);
    alert(`${team} gets 3 points!`);
}

function markWrong(team) {
    db.ref("hotSeat/buzzOrder").once("value").then(bSnap => {
        let order = bSnap.val() || [];
        order = order.filter(t => t !== team);
        db.ref("hotSeat/buzzOrder").set(order);

        db.ref("hotSeat/wrongTeams").once("value").then(wSnap => {
            let wrongTeams = wSnap.val() || [];
            if (!wrongTeams.includes(team)) wrongTeams.push(team);
            db.ref("hotSeat/wrongTeams").set(wrongTeams);

            // Remove buzzTime entry so timer stops
            db.ref(`hotSeat/buzzTimes/${team}`).remove();

            if (order.length === 0) {
                alert("❌ All teams were wrong — buzzers reopened!");
                db.ref("hotSeat/wrongTeams").set([]);
            }
        });
    });
}

// ==================== RESET GAME ====================
function resetGame() {
    if (confirm("Reset Hot Seat game? This clears all scores & buzz orders.")) {
        db.ref("hotSeat").set({
            currentRound: 1,
            buzzOrder: [],
            buzzTimes: {},
            wrongTeams: [],
            currentBuzz: null,
            roundActive: false,
            roundStartTime: null
        });
        db.ref("teams").set({});
        db.ref("resetFlags/gameReset").set(Date.now());
    }
}

// ==================== SCORE TABLE ====================
db.ref("teams").on("value", snap => {
    const teams = snap.val() || {};
    const tbody = document.getElementById("scoreTable");
    tbody.innerHTML = "";
    Object.keys(teams).forEach(team => {
        tbody.innerHTML += `<tr><td>${team}</td><td>${teams[team].score || 0}</td></tr>`;
    });
});

// ==================== WINNER ====================
function declareWinner() {
    const winner = document.getElementById('winnerSelect').value;
    if (!winner) {
        alert("Please select a team to declare as winner!");
        return;
    }
    db.ref('wins/' + winner).transaction(currentWins => (currentWins || 0) + 1)
        .then(() => alert(`${winner} wins this mini-game! 🏆`))
        .catch(error => console.error("Error updating winner:", error));
}
</script>
</body>
</html>